
# Absensi Madrasah Darul Inayah

Aplikasi manajemen absensi komprehensif untuk Madrasah Aliyah Darul Inayah. Aplikasi ini memungkinkan guru untuk mengelola data siswa, melacak kehadiran, dan membuat laporan. Orang tua juga dapat melihat catatan kehadiran anak mereka melalui portal khusus.

## Fitur Utama

- **Dashboard Guru**: Tampilan ringkas statistik kehadiran, total siswa, dan riwayat aktivitas terbaru.
- **Manajemen Data Siswa**: Tambah, edit, dan upload data siswa secara massal melalui file Excel.
- **Input Absensi Harian**: Pencatatan kehadiran yang mudah per kelas, per tanggal, dan per jam pelajaran.
- **Laporan Absensi**: Buat dan unduh laporan kehadiran bulanan dalam format PDF atau Excel.
- **Portal Orang Tua**: Orang tua dapat memeriksa rekap absensi anak mereka tanpa perlu login, cukup dengan NISN atau Nama & Tanggal Lahir.

---

## 1. Panduan Setup & Eksekusi

Untuk menjalankan aplikasi ini, Anda perlu menyiapkan database di Supabase terlebih dahulu.

### a. Kebutuhan
- Akun [Supabase](https://supabase.com/).

### b. Setup Database Supabase
1.  Buat proyek baru di Supabase.
2.  Masuk ke **SQL Editor** dari menu di sebelah kiri.
3.  Salin seluruh isi **Script SQL** di bawah ini, tempelkan ke editor, dan klik **"RUN"**. Script ini akan membuat semua tabel, fungsi, dan kebijakan keamanan yang dibutuhkan oleh aplikasi.

### c. Konfigurasi Aplikasi
Pastikan URL dan *anon key* Supabase di dalam file `services/api.ts` sudah sesuai dengan kredensial proyek Supabase Anda.
```javascript
// file: services/api.ts
const supabaseUrl = 'https://wliodivdqqeorbpniimv.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Key Anda
```

### d. Menjalankan Aplikasi
Aplikasi ini adalah aplikasi web statis. Cukup buka file `index.html` di browser Anda untuk menjalankannya.

---

## 2. Script SQL untuk Supabase

Jalankan script berikut di **SQL Editor** Supabase Anda.

```sql
-- ##############################################################
-- ## SCRIPT SETUP DATABASE UNTUK APLIKASI ABSENSI MA DARUL INAYAH
-- ##############################################################

-- 1. MEMBUAT TABEL-TABEL YANG DIBUTUHKAN
-- =======================================

-- Tabel untuk menyimpan profil publik (khususnya guru)
-- Terhubung dengan sistem otentikasi Supabase.
CREATE TABLE public.profiles (
  id uuid NOT NULL PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  name text NOT NULL,
  role text NOT NULL CHECK (role IN ('teacher', 'parent'))
);
COMMENT ON TABLE public.profiles IS 'Menyimpan data publik pengguna seperti nama dan peran (role).';

-- Tabel untuk menyimpan data siswa
CREATE TABLE public.students (
  id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  nisn text UNIQUE,
  date_of_birth date, -- Menambahkan kolom tanggal lahir
  grade text NOT NULL CHECK (grade IN ('10', '11', '12')),
  class_letter text NOT NULL CHECK (class_letter IN ('A', 'B')),
  gender text NOT NULL CHECK (gender IN ('L', 'P')),
  parent_id uuid NULL REFERENCES public.profiles(id) ON DELETE SET NULL
);
COMMENT ON TABLE public.students IS 'Menyimpan semua data siswa di sekolah.';

-- Tabel untuk menyimpan catatan kehadiran harian
CREATE TABLE public.attendance_records (
  id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id uuid NOT NULL REFERENCES public.students(id) ON DELETE CASCADE,
  date date NOT NULL,
  class_period smallint NOT NULL CHECK (class_period > 0),
  status text NOT NULL CHECK (status IN ('Hadir', 'Sakit', 'Izin', 'Alpa')),
  -- Memastikan satu catatan unik per siswa, per hari, per jam pelajaran
  UNIQUE (student_id, date, class_period)
);
COMMENT ON TABLE public.attendance_records IS 'Mencatat kehadiran setiap siswa untuk setiap jam pelajaran.';

-- Tabel untuk log histori aktivitas pengguna (jejak audit)
CREATE TABLE public.history_logs (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    timestamp timestamptz NOT NULL DEFAULT now(),
    user_name text NOT NULL,
    action text NOT NULL
);
COMMENT ON TABLE public.history_logs IS 'Jejak audit untuk aksi-aksi penting dalam aplikasi.';


-- 2. OTOMATISASI: BUAT PROFIL SAAT ADA PENDAFTARAN PENGGUNA BARU
-- =============================================================

-- Fungsi ini akan dipicu saat ada pengguna baru mendaftar.
-- Fungsi ini menyalin ID, nama, dan peran dari auth.users ke tabel public.profiles.
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  INSERT INTO public.profiles (id, name, role)
  VALUES (NEW.id, NEW.raw_user_meta_data->>'name', NEW.raw_user_meta_data->>'role');
  RETURN NEW;
END;
$$;

-- Trigger yang menjalankan fungsi di atas setelah ada pengguna baru ditambahkan.
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

COMMENT ON FUNCTION public.handle_new_user() IS 'Otomatis membuat profil untuk pengguna baru.';


-- 3. KEBIJAKAN KEAMANAN (ROW-LEVEL SECURITY / RLS)
-- ==================================================
-- RLS harus diaktifkan untuk setiap tabel, lalu kebijakannya didefinisikan.

-- Aktifkan RLS untuk semua tabel
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.students ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.attendance_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.history_logs ENABLE ROW LEVEL SECURITY;

-- Fungsi helper untuk mendapatkan peran (role) pengguna yang sedang login
CREATE OR REPLACE FUNCTION public.get_user_role()
RETURNS text LANGUAGE sql STABLE AS $$
  SELECT role FROM public.profiles WHERE id = auth.uid();
$$;

-- KEBIJAKAN UNTUK TABEL 'profiles'
CREATE POLICY "Allow individual read access" ON public.profiles FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Allow teachers to read all profiles" ON public.profiles FOR SELECT USING (public.get_user_role() = 'teacher');

-- KEBIJAKAN UNTUK TABEL 'students'
CREATE POLICY "Allow public read access for ParentView" ON public.students FOR SELECT USING (true);
CREATE POLICY "Allow full access for teachers" ON public.students FOR ALL USING (public.get_user_role() = 'teacher') WITH CHECK (public.get_user_role() = 'teacher');

-- KEBIJAKAN UNTUK TABEL 'attendance_records'
CREATE POLICY "Allow public read access for ParentView" ON public.attendance_records FOR SELECT USING (true);
CREATE POLICY "Allow full access for teachers" ON public.attendance_records FOR ALL USING (public.get_user_role() = 'teacher') WITH CHECK (public.get_user_role() = 'teacher');

-- KEBIJAKAN UNTUK TABEL 'history_logs'
CREATE POLICY "Allow full access for teachers" ON public.history_logs FOR ALL USING (public.get_user_role() = 'teacher') WITH CHECK (public.get_user_role() = 'teacher');

-- --- AKHIR DARI SCRIPT ---
```

---

## 3. Format Upload Excel yang Tepat

Untuk menggunakan fitur **Upload Excel** pada halaman Data Siswa, pastikan file `.xlsx` Anda memiliki kolom-kolom dengan nama persis seperti di bawah ini. Baris pertama harus berisi nama-nama kolom ini.

| Nama Kolom      | Tipe Data      | Keterangan                                     | Contoh            |
|-----------------|----------------|------------------------------------------------|-------------------|
| **Nama**        | Teks           | **Wajib.** Nama lengkap siswa.                 | Budi Santoso      |
| **NISN**        | Angka atau Teks| Opsional. Nomor Induk Siswa Nasional.          | 0071234567        |
| **Tanggal Lahir**| Tanggal        | Opsional. Gunakan format `YYYY-MM-DD`.        | 2007-05-15        |
| **Kelas**       | Angka          | **Wajib.** Hanya angka `10`, `11`, atau `12`.      | 11                |
| **Jenis Kelamin**| Teks           | **Wajib.** `L` untuk Laki-laki, `P` untuk Perempuan. | L                 |

**Penting:**
- Urutan kolom tidak menjadi masalah.
- Pastikan nama kolom ditulis dengan benar (termasuk huruf besar/kecil dan spasi).
- Aplikasi secara otomatis akan menentukan `classLetter` ('A' atau 'B') berdasarkan jenis kelamin.

---

## 4. Cara Update Kode ke GitHub

Jika Anda melakukan perubahan pada kode dan ingin menyimpannya ke GitHub, ikuti langkah-langkah sederhana berikut menggunakan terminal atau command prompt di folder proyek Anda.

### Langkah 1: Tambahkan semua perubahan
Perintah ini akan menyiapkan semua file yang telah Anda ubah untuk disimpan.
```bash
git add .
```

### Langkah 2: Simpan perubahan dengan sebuah pesan
Perintah ini akan menyimpan perubahan secara lokal di komputer Anda. Ganti `"Pesan update"` dengan deskripsi singkat tentang perubahan yang Anda buat (contoh: `"Memperbaiki tampilan tombol"`).
```bash
git commit -m "Pesan update"
```

### Langkah 3: Unggah perubahan ke GitHub
Perintah ini akan mengirim semua perubahan yang sudah Anda simpan ke repository online di GitHub.
```bash
git push
```
