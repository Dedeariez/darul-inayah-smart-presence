# Absensi Madrasah Darul Inayah

Aplikasi manajemen absensi komprehensif untuk Madrasah Aliyah Darul Inayah. Aplikasi ini memungkinkan guru untuk mengelola data siswa, melacak kehadiran, dan membuat laporan. Orang tua juga dapat melihat catatan kehadiran anak mereka melalui portal khusus.

## Fitur Utama

- **Dashboard Guru**: Tampilan ringkas statistik kehadiran, total siswa, dan riwayat aktivitas terbaru.
- **Manajemen Data Siswa**: Tambah, edit, dan upload data siswa secara massal melalui file Excel.
- **Input Absensi Harian**: Pencatatan kehadiran yang mudah per kelas, per tanggal, dan per jam pelajaran.
- **Laporan Absensi**: Buat dan unduh laporan kehadiran bulanan dalam format PDF atau Excel.
- **Portal Orang Tua**: Orang tua dapat memeriksa rekap absensi anak mereka tanpa perlu login, cukup dengan NISN atau Nama & Tanggal Lahir.

---

## 1. Panduan Setup & Eksekusi

Untuk menjalankan aplikasi ini, Anda perlu menyiapkan database di Supabase terlebih dahulu.

### a. Kebutuhan
- Akun [Supabase](https://supabase.com/).

### b. Setup Database Supabase
1.  Buat proyek baru di Supabase.
2.  Masuk ke **SQL Editor** dari menu di sebelah kiri.
3.  Salin seluruh isi **Script SQL** di bawah ini, tempelkan ke editor, dan klik **"RUN"**. Script ini akan membuat ulang semua tabel, fungsi, dan kebijakan keamanan yang dibutuhkan oleh aplikasi.

### c. Konfigurasi Aplikasi
Pastikan URL dan *anon key* Supabase di dalam file `services/api.ts` sudah sesuai dengan kredensial proyek Supabase Anda.
```javascript
// file: services/api.ts
const supabaseUrl = 'https://wliodivdqqeorbpniimv.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Key Anda
```

### d. Menjalankan Aplikasi
Aplikasi ini adalah aplikasi web statis. Cukup buka file `index.html` di browser Anda untuk menjalankannya.

---

## 2. Script Reset SQL untuk Supabase

**PENTING:** Jika Anda mengalami error **"stack depth limit exceeded"**, **"RLS recursion"**, atau **"Gagal memuat sesi pengguna"**, itu berarti konfigurasi database Anda bermasalah. Menjalankan ulang seluruh script di bawah ini akan **memperbaikinya** dengan menghapus konfigurasi lama dan membuat yang baru.

```sql
-- ####################################################################
-- ## SCRIPT RESET DATABASE UNTUK APLIKASI ABSENSI MA DARUL INAYAH ##
-- ####################################################################

-- STEP 1: HAPUS SEMUA OBJEK LAMA UNTUK MEMASTIKAN AWALAN YANG BERSIH
-- =================================================================
-- Hapus trigger dan fungsi lama terlebih dahulu.
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
DROP FUNCTION IF EXISTS public.handle_new_user() CASCADE;
DROP FUNCTION IF EXISTS public.get_user_role() CASCADE;

-- Hapus tabel-tabel lama. `CASCADE` akan menghapus semua objek yang bergantung padanya.
DROP TABLE IF EXISTS public.history_logs CASCADE;
DROP TABLE IF EXISTS public.attendance_records CASCADE;
DROP TABLE IF EXISTS public.students CASCADE;
DROP TABLE IF EXISTS public.profiles CASCADE;


-- STEP 2: BUAT ULANG SEMUA TABEL
-- ===============================

-- Tabel untuk menyimpan profil publik (khususnya guru). Terhubung dengan `auth.users`.
CREATE TABLE public.profiles (
  id uuid NOT NULL PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  name text NOT NULL,
  role text NOT NULL CHECK (role IN ('teacher', 'parent'))
);
COMMENT ON TABLE public.profiles IS 'Menyimpan data publik pengguna seperti nama dan peran (role).';

-- Tabel untuk menyimpan data siswa.
CREATE TABLE public.students (
  id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  nisn text UNIQUE,
  date_of_birth date,
  grade text NOT NULL CHECK (grade IN ('10', '11', '12')),
  class_letter text NOT NULL CHECK (class_letter IN ('A', 'B')),
  gender text NOT NULL CHECK (gender IN ('L', 'P')),
  parent_id uuid NULL REFERENCES public.profiles(id) ON DELETE SET NULL
);
COMMENT ON TABLE public.students IS 'Menyimpan semua data siswa di sekolah.';

-- Tabel untuk menyimpan catatan kehadiran harian.
CREATE TABLE public.attendance_records (
  id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id uuid NOT NULL REFERENCES public.students(id) ON DELETE CASCADE,
  date date NOT NULL,
  class_period smallint NOT NULL CHECK (class_period > 0),
  status text NOT NULL CHECK (status IN ('Hadir', 'Sakit', 'Izin', 'Alpa')),
  UNIQUE (student_id, date, class_period)
);
COMMENT ON TABLE public.attendance_records IS 'Mencatat kehadiran setiap siswa untuk setiap jam pelajaran.';

-- Tabel untuk log histori aktivitas pengguna (jejak audit).
CREATE TABLE public.history_logs (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    timestamp timestamptz NOT NULL DEFAULT now(),
    user_name text NOT NULL,
    action text NOT NULL
);
COMMENT ON TABLE public.history_logs IS 'Jejak audit untuk aksi-aksi penting dalam aplikasi.';


-- STEP 3: BUAT ULANG FUNGSI DAN TRIGGER
-- =======================================

-- Fungsi ini dipicu saat ada pengguna baru mendaftar untuk menyalin datanya ke tabel `profiles`.
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  INSERT INTO public.profiles (id, name, role)
  VALUES (NEW.id, NEW.raw_user_meta_data->>'name', NEW.raw_user_meta_data->>'role');
  RETURN NEW;
END;
$$;

-- Trigger yang menjalankan fungsi di atas setelah ada pengguna baru ditambahkan di `auth.users`.
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- Fungsi helper untuk mendapatkan peran (role) pengguna yang sedang login.
-- PENTING: Fungsi ini WAJIB menggunakan `SECURITY DEFINER`.
-- Ini adalah KUNCI untuk mencegah error "stack depth limit exceeded" (rekursi tak terbatas).
-- `SECURITY DEFINER` membuat kueri di dalam fungsi ini berjalan dengan hak akses SUPERUSER,
-- sehingga BISA MELEWATI (bypass) pengecekan RLS di tabel `profiles` dan menghentikan loop rekursif.
CREATE OR REPLACE FUNCTION public.get_user_role()
RETURNS text
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
STABLE AS $$
BEGIN
  RETURN (SELECT p.role FROM public.profiles p WHERE p.id = auth.uid());
END;
$$;


-- STEP 4: AKTIFKAN RLS DAN BUAT ULANG KEBIJAKAN KEAMANAN
-- ========================================================
-- Selalu aktifkan RLS untuk setiap tabel yang akan diamankan.
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.students ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.attendance_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.history_logs ENABLE ROW LEVEL SECURITY;

-- KEBIJAKAN UNTUK TABEL 'profiles'
DROP POLICY IF EXISTS "Allow individual read access" ON public.profiles;
-- Pengguna hanya boleh membaca profilnya sendiri.
CREATE POLICY "Allow individual read access" ON public.profiles FOR SELECT USING (auth.uid() = id);

-- KEBIJAKAN UNTUK TABEL 'students'
DROP POLICY IF EXISTS "Allow public read access for ParentView" ON public.students;
DROP POLICY IF EXISTS "Allow full access for teachers" ON public.students;
-- Siapa saja (termasuk non-login) boleh membaca data siswa untuk fitur "Cari Siswa".
CREATE POLICY "Allow public read access for ParentView" ON public.students FOR SELECT USING (true);
-- Hanya guru yang boleh menambah, mengubah, dan menghapus data siswa.
CREATE POLICY "Allow full access for teachers" ON public.students FOR ALL USING (public.get_user_role() = 'teacher') WITH CHECK (public.get_user_role() = 'teacher');

-- KEBIJAKAN UNTUK TABEL 'attendance_records'
DROP POLICY IF EXISTS "Allow public read access for ParentView" ON public.attendance_records;
DROP POLICY IF EXISTS "Allow full access for teachers" ON public.attendance_records;
-- Siapa saja boleh membaca catatan absensi untuk fitur "Cari Siswa".
CREATE POLICY "Allow public read access for ParentView" ON public.attendance_records FOR SELECT USING (true);
-- Hanya guru yang boleh mengelola catatan absensi.
CREATE POLICY "Allow full access for teachers" ON public.attendance_records FOR ALL USING (public.get_user_role() = 'teacher') WITH CHECK (public.get_user_role() = 'teacher');

-- KEBIJAKAN UNTUK TABEL 'history_logs'
DROP POLICY IF EXISTS "Allow full access for teachers" ON public.history_logs;
-- Hanya guru yang boleh melihat dan membuat log histori.
CREATE POLICY "Allow full access for teachers" ON public.history_logs FOR ALL USING (public.get_user_role() = 'teacher') WITH CHECK (public.get_user_role() = 'teacher');


-- --- AKHIR DARI SCRIPT ---
-- Selamat! Database Anda sekarang sudah terkonfigurasi dengan benar.
```

---

## 3. Format Upload Excel yang Tepat

Untuk menggunakan fitur **Upload Excel** pada halaman Data Siswa, pastikan file `.xlsx` Anda memiliki kolom-kolom dengan nama persis seperti di bawah ini. Baris pertama harus berisi nama-nama kolom ini.

| Nama Kolom      | Tipe Data      | Keterangan                                     | Contoh            |
|-----------------|----------------|------------------------------------------------|-------------------|
| **Nama**        | Teks           | **Wajib.** Nama lengkap siswa.                 | Budi Santoso      |
| **NISN**        | Angka atau Teks| Opsional. Nomor Induk Siswa Nasional.          | 0071234567        |
| **Tanggal Lahir**| Tanggal        | Opsional. Gunakan format `YYYY-MM-DD`.        | 2007-05-15        |
| **Kelas**       | Angka          | **Wajib.** Hanya angka `10`, `11`, atau `12`.      | 11                |
| **Jenis Kelamin**| Teks           | **Wajib.** `L` untuk Laki-laki, `P` untuk Perempuan. | L                 |

**Penting:**
- Urutan kolom tidak menjadi masalah.
- Pastikan nama kolom ditulis dengan benar (termasuk huruf besar/kecil dan spasi).
- Aplikasi secara otomatis akan menentukan `classLetter` ('A' atau 'B') berdasarkan jenis kelamin.

---

## 4. Cara Update Kode ke GitHub

Jika Anda melakukan perubahan pada kode dan ingin menyimpannya ke GitHub, ikuti langkah-langkah sederhana berikut menggunakan terminal atau command prompt di folder proyek Anda.

### Langkah 1: Tambahkan semua perubahan
Perintah ini akan menyiapkan semua file yang telah Anda ubah untuk disimpan.
```bash
git add .
```

### Langkah 2: Simpan perubahan dengan sebuah pesan
Perintah ini akan menyimpan perubahan secara lokal di komputer Anda. Ganti `"Pesan update"` dengan deskripsi singkat tentang perubahan yang Anda buat (contoh: `"Memperbaiki tampilan tombol"`).
```bash
git commit -m "Pesan update"
```

### Langkah 3: Unggah perubahan ke GitHub
Perintah ini akan mengirim semua perubahan yang sudah Anda simpan ke repository online di GitHub.
```bash
git push
```
